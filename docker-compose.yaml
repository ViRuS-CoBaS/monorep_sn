services:
  angie:
    build:
      context: ./config/angie  # Директория с Dockerfile (config/angie/)
      dockerfile: Dockerfile
    ports:
      - "8080:80"   # HTTP redirect
      - "8443:443"  # HTTPS/HTTP3 (TCP + UDP для quic)
    volumes:
      - ${ANGIE_CONF}:/etc/angie/angie.conf:ro    # ./config/angie/dev.conf
      - ${ANGIE_HTTPD}:/tmp/default.conf  # ./config/angie/dev.conf
      - ${ANGIE_CONF_SSL_DIR}:/etc/angie/ssl
      - ${LOGS_DIR}/angie:/var/log/angie  # Логи в backend/logs/
    depends_on:
      - frankenphp
      - mercure
    networks:
      - my-stack-network
    restart: unless-stopped
    environment:
      - NGINX_ENTRYPOINT_QUIET_LOGS=1
      - APP_ENV=${APP_ENV}
      - APP_DOMAIN=${APP_DOMAIN}
      - APP_HTTPS_PORT=${APP_HTTPS_PORT}
    profiles:
      - dev
      - prod
  frankenphp:
    build:
      context: ./app  # Строит из app/ (код Symfony)
      dockerfile: Dockerfile  # Dockerfile из корня
      args:
        - APP_ENV=${APP_ENV}
    volumes:
      # Dev: Hot-reload; Prod: без (закомментируйте или используйте profiles)
      - ${APP_ENV:+./app:/app}
      - ${PHP_INI_FILE}:/usr/local/etc/php/conf.d/extra.ini:ro  # ./config/php/dev.ini
      - ${CADDY_FILE}:/etc/frankenphp/Caddyfile:ro  # ./config/frankenphp/dev.Caddyfile
    env_file:
      - .env.dev
    #    environment:
    #      - APP_RUNTIME=Runtime\FrankenPhpSymfony\Runtime
    #      - DATABASE_URL=${DATABASE_URL}
    #      - DATABASE_URL=${DATABASE_URL}
    #      - DATABASE_URL_CCS=${DATABASE_URL_CCS}
    #      - REDIS_URL=redis://redis:6379
    #      - DEFAULT_URI=${DEFAULT_URI}
    #      - MERCURE_SUBSCRIBER_JWT_KEY=${MERCURE_SUBSCRIBER_JWT_KEY}
    #      - MERCURE_PUBLISHER_JWT_KEY=${MERCURE_PUBLISHER_JWT_KEY}
    #      - MERCURE_URL=${MERCURE_URL}
    #      - MERCURE_PUBLIC_URL=${MERCURE_PUBLIC_URL}
    #      - MERCURE_PUBLIC_URL=${MERCURE_PUBLIC_URL}
    #      - MAILER_DSN=${MAILER_DSN}
    #      - MESSENGER_TRANSPORT_DSN=${MESSENGER_TRANSPORT_DSN}
    #      - APP_ENV=${APP_ENV}
    #      - TRUSTED_PROXIES=angie
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - my-stack-network
    restart: unless-stopped
    profiles:
      - dev
      - prod
  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_READ_DB=${POSTGRES_READ_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ${POSTGRES_CONF_DIR}/postgres.${APP_ENV}.conf:/etc/postgresql/postgresql.conf
      - ${POSTGRES_CONF_DIR}/entrypoint.sh:/docker-entrypoint-initdb.d/20-entrypoint.sh
      - ${DATA_DIR}/postgres:/var/lib/postgresql
      - ${LOGS_DIR}/postgres:/var/log/postgresql
    ports:
      - "5433:5432"
    networks:
      - my-stack-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "pg_isready", "-d", "${POSTGRES_DB}", "-U", "${POSTGRES_USER}" ]
      timeout: 5s
      retries: 5
      start_period: 60s
  redis:
    image: redis:8.2.2-alpine3.22
    command: redis-server --logfile /var/log/redis/redis-server.log --loglevel warning
    volumes:
      - ${DATA_DIR}/redis:/data
      - ${LOGS_DIR}/redis:/var/log/redis
    networks:
      - my-stack-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      timeout: 5s
      retries: 5
      start_period: 60s
  mercure:
    image: dunglas/mercure:latest  # Официальный образ (v0.16+ на 2025)
    ports:
      - "3000:80"  # Локальный доступ (опционально; прокси через Angie)
    volumes:
      - ${LOGS_DIR}/mercure:/var/log/mercure  # Логи в ./logs/mercure/
    environment:
      - CORS_ORIGINS=*  # Разрешить все origins (в prod: укажите домены)
      - JWT_KEY=your-jwt-secret-key  # Тот же ключ, что в .env (генерируйте)
      - MERCURE_PUBLISHER_JWT_KEY=${MERCURE_PUBLISHER_JWT_KEY}  # Из .env
      - MERCURE_SUBSCRIBER_JWT_KEY=${MERCURE_SUBSCRIBER_JWT_KEY}  # Из .env
      - REDIS_URL=redis://redis:6379  # Опционально: для scaling (pub/sub)
      - APP_ENV=${APP_ENV}
    depends_on:
      - redis
    networks:
      - my-stack-network
    restart: unless-stopped
    profiles:
      - dev
      - prod
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/.well-known/mercure" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
volumes:
  pgdata:
networks:
  my-stack-network:
    driver: bridge